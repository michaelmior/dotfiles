export PATH="$HOME/bin:$HOME/.cargo/bin:$HOME/.bin:$HOME/.local/bin:$HOME/n/bin:/Library/TeX/texbin/:$PATH"

# Turn on autopushd
setopt autopushd

# Remove / from WORDCHARS to consider path parts as words
export WORDCHARS=${WORDCHARS/[\/.]}

# Set default less options
export LESS=MFSRX

# n (node version manager)
export N_PREFIX="$HOME/n"

# Set window title to current directory
function set_win_title(){
    echo -ne "\033]0; $(basename "$PWD") \007"
}
precmd_functions+=(set_win_title)

# Starship
eval "$(starship init zsh)"

# SDKMAN
export SDKMAN_DIR=$(brew --prefix sdkman-cli)/libexec
[[ -s "${SDKMAN_DIR}/bin/sdkman-init.sh" ]] && source "${SDKMAN_DIR}/bin/sdkman-init.sh"

# Enable autocompletion
autoload -Uz compinit && compinit
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'

{{- if eq .chezmoi.os "darwin" }}

# Enable iterm2 shell integration on macOS
source ~/.iterm2_shell_integration.zsh

# Use GNU tools without prefix
path=(
  /opt/homebrew/bin
  /opt/homebrew/opt/coreutils/libexec/gnubin
  /opt/homebrew/opt/grep/libexec/gnubin
  $path
)
{{- end }}

# Perl
PATH="{{ .chezmoi.homeDir }}/perl5/bin${PATH:+:${PATH}}"; export PATH;
PERL5LIB="{{ .chezmoi.homeDir }}/perl5/lib/perl5${PERL5LIB:+:${PERL5LIB}}"; export PERL5LIB;
PERL_LOCAL_LIB_ROOT="{{ .chezmoi.homeDir }}/perl5${PERL_LOCAL_LIB_ROOT:+:${PERL_LOCAL_LIB_ROOT}}"; export PERL_LOCAL_LIB_ROOT;
PERL_MB_OPT="--install_base \"{{ .chezmoi.homeDir }}/perl5\""; export PERL_MB_OPT;
PERL_MM_OPT="INSTALL_BASE={{ .chezmoi.homeDir }}/perl5"; export PERL_MM_OPT;

{{- if eq .chezmoi.os "darwin" }}
# macOS-specific Ruby config
export PATH="/opt/homebrew/opt/ruby/bin:$PATH"
export LDFLAGS="-L/opt/homebrew/opt/ruby/lib"
export CPPFLAGS="-I/opt/homebrew/opt/ruby/include"
{{- end }}

{{- if eq .chezmoi.os "darwin" }}
# macOS config for libpq
export PATH="/opt/homebrew/opt/libpq/bin:$PATH"
export LDFLAGS="-L/opt/homebrew/opt/libpq/lib"
export CPPFLAGS="-I/opt/homebrew/opt/libpq/include"
export PKG_CONFIG_PATH="/opt/homebrew/opt/libpq/lib/pkgconfig"
{{- end }}

# Aliases
export EDITOR=nvim
alias vim=nvim
alias gl="git log"
alias ga="git add"
alias gap="git add --patch"
alias gash="git stash"
alias gco="git checkout"
alias gd="git diff"
alias gf="git fetch"
alias gp="git push"
alias gs="git status"
alias gdc="git diff --cached"
alias gpl="git pull"
alias grb="git rebase"
alias grbi="git rebase --interactive"
alias grhh="git reset --hard HEAD"
alias gsh="git show"
jql () { jq -C . $* | less -R }
rgl () { rg --color always --heading $* | less -R }

# Configure TTY for gpg
export GPG_TTY=$(tty)

# bun
[ -s "{{ .chezmoi.homeDir }}/.bun/_bun" ] && source "{{ .chezmoi.homeDir }}/.bun/_bun"
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

if type brew &>/dev/null; then
  source $(brew --prefix)/share/zsh-autosuggestions/zsh-autosuggestions.zsh
  FPATH=$(brew --prefix)/share/zsh-completions:$FPATH

  autoload -Uz compinit
  compinit
fi

export CARAPACE_BRIDGES='zsh,fish,bash,inshellisense' # optional
zstyle ':completion:*' format $'\e[2;37mCompleting %d\e[m'
source <(carapace _carapace)

# Custom functions
fpath+=(~/.zsh-functions)
autoload -Uz compinit && compinit
autoload -Uz git-escape-magic
git-escape-magic

{{- if eq .chezmoi.os "darwin" }}
source /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
{{- end }}

# fzf
source <(fzf --zsh)

export FZF_DEFAULT_COMMAND='fd --type f ""'
export FZF_CTRL_T_COMMAND='fd --type f ""'
export FZF_CTRL_T_OPTS="
  --preview 'bat -n --color=always {}'
  --bind 'ctrl-/:change-preview-window(down|hidden|)'"
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
zle     -N   fzf-file-widget
bindkey -M viins '^P' fzf-file-widget
bindkey -M viins '^O' fzf-cd-widget

fzf-edit() {
  fzf-file-widget 1
  [[ -z $BUFFER ]] && return
  zle beginning-of-line
  LBUFFER="vim "
  zle accept-line
}
zle     -N   fzf-edit
bindkey -M viins '^T' fzf-edit

# Vim mode
bindkey -v

# Krew
export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"

# Atuin
eval "$(atuin init zsh)"

# pyenv
export PYENV_ROOT="$HOME/.pyenv"
[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init - zsh)"

{{- if eq .chezmoi.os "darwin" }}
# pnpm
export PNPM_HOME="/Users/mjmvcs/Library/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end
{{- end }}

# Mise
eval "$(mise activate zsh)"
mise use -g uv &> /dev/null

# Add command to quickly start or reattach to a tmux session by name
tm() {
    if [ -z $1 ]; then
        tmux list-sessions
        return
    fi
    tmux detach -s $1 2> /dev/null
    if [ -n "${TMUX+1}" ]; then
        tmux switch-client -t $1 2> /dev/null || tmux new-session -s $1
    else
        tmux attach-session -t $1 2> /dev/null || tmux new-session -s $1
    fi
}

_tm() {
  local word completions
  word="$1"
  sessions=`tmux list-sessions 2> /dev/null`
  [ $? -ne 0 ] && return
  completions=`echo "$sessions" | cut -d ':' -f1`
  reply=( "${(f)completions}" )
}
compctl -K _tm tm

# Allow local overrides and extra settings
[[ -f ~/.localrc ]] && source ~/.localrc
